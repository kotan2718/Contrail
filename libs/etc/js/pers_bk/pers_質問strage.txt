
//////////////
問題解決
//////////////


htmlとjavascriptについての質問です。

webページのセレクトボックスで選択された番号と、
描画ウインドウの背景色をlocal strageに保存したいと考えています。
セレクトボックの番号はうまくストレージに保存され、
リロードなどでwebページを開き直すと、その設定が反映されています。

描画ウインドウの背景色はwebパージのチェックボックスをチェックしなければ、'rgb(0, 0, 0)'が指定され、
チェックされた場合は、'rgb(255, 255, 255)'がセットされてローカルストレージに保存するつもりです。
しかし、チェックを入れた後にchange eventを実行して、背景色を白色にしてからページを開き直すと、
チェックは入った状態なのですが、背景色は黒色になってしまいます。
開発者ツールでローカルストレージを確認すると

kzPers_BackColor   : 'rgb(255, 255, 255)'
kzPers_Storage2Flg : true

となっています。
ストレージに保存されているデータの呼び出し方




==html==

<!DOCTYPE HTML >
<html>

<HEAD>
    <META charset="UTF-8">
        <!-- pers initialize -->
        <script src="libs/etc/js/pers00_v1.js" type="text/javascript"></script>
</HEAD>

<BODY id="common-k"  onload="initialize()">
    <div id="container">
        <select id="type" style="width: 360px;" onchange="changeType()">
            <option disabled selected">[01] 関数諸例</option>
            <option value="01&01">&nbsp; 1. f(x,y) = x^4 + xy - y^4</option>
            <option value="01&02">&nbsp; 2. f(x,y) = (y - x^2)^2 + x^5</option>
        </select>

        <div class="grid2b">
            <p class="fss" align="left">
                <input type="checkbox" id="pers_storage" onclick="handleCheckboxStorage(this.checked)">&nbsp; keep list pos.
            </p>
            <p class="fss" align="left">
                <input type="checkbox" id="cb_bk_color" onclick="handleCheckboxBackColor(this.checked)">&nbsp; change back col.
            </p>
        </div>
        <!-- pers javascript呼び出し -->
        <script src="libs/etc/js/pers01_v1.js" type="text/javascript"></script>
    </div>
</BODY>
<html>


==pers00_v1.js==

document.addEventListener('DOMContentLoaded', (event) => {

    // list
    // ローカルストレージから選択状態を取得
    const selectedValue = localStorage.getItem('kzPers_SelectedType');
    const checkboxState = localStorage.getItem('kzPers_StorageFlg') === 'true';
    if (selectedValue) {
        document.getElementById('type').value = selectedValue;
    }
    if (checkboxState) {
        document.getElementById('pers_storage').checked = true;
    }
    // back color
    // ローカルストレージから選択状態を取得
    const backColorValue = localStorage.getItem('kzPers_BackColor');
    const backColorCBState = localStorage.getItem('kzPers_Storage2Flg') === 'true';
    if (backColorValue) {
        document.getElementById('kzPers_BackColor').value = backColorValue;
    }
    if (backColorCBState) {
        document.getElementById('cb_bk_color').checked = true;
    }

});


==pers01_v1.js==

let bkColor = 'rgb(0, 0, 0)';

// 描画領域をリセット
ctx.fillStyle = bkColor;
ctx.fillRect(0, 0, canvas.width, canvas.height);

/// ストレージフラグ
function handleCheckboxStorage(flg) {
    kzPers_StorageFlg = flg;
    localStorage.setItem('kzPers_StorageFlg', flg);
    if (!flg) {
        localStorage.removeItem('kzPers_SelectedType');
        localStorage.removeItem('kzPers_StorageFlg'); // フラグを削除
    }
}
function handleCheckboxBackColor(flg) {
    kzPers_Storage2Flg = flg;
    localStorage.setItem('kzPers_Storage2Flg', flg);
    if (!flg) {
        bkColor = 'rgb(0, 0, 0)';
        localStorage.removeItem('kzPers_BackColor');
        localStorage.removeItem('kzPers_Storage2Flg'); // フラグを削除
    }
    else {
        bkColor = 'rgb(255, 255, 255)';
    }
}

// 描画関数の変更
function changeType() {
    const type = String(document.getElementById('type').value);

    // ここでチェックボックスの状態を確認し、ストレージフラグを更新
    kzPers_StorageFlg = document.getElementById('pers_storage').checked;
    if (kzPers_StorageFlg == true) {
        // 選択状態をローカルストレージに保存
        localStorage.setItem('kzPers_SelectedType', type);
    }

    kzPers_Storage2Flg = document.getElementById('cb_bk_color').checked;
    if (kzPers_Storage2Flg == true) {
        // 選択状態をローカルストレージに保存
        localStorage.setItem('kzPers_BackColor', 'rgb(255, 255, 255)');
    }
}

